# Wan Bricks Implementation Summary

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

–°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `wan_bricks` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Wan (‰∏áÁâ©) –º–æ–¥–µ–ª–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ ComfyUI.

## –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å
- **`wan_bricks.py`** (8.9 KB)
  - 5 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Wan
  - –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ docstrings
  - –ò–º–ø–æ—Ä—Ç—ã –∏–∑ –ø–æ–ª–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ComfyUI
  - –¢–∏–ø–∏–∑–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 2. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **`README_WAN.md`** (7.4 KB)
  - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
  - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  - –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –º–æ–¥–µ–ª—è–º
  - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –¥–µ—Ç–∞–ª–∏

- **`WAN_COMPONENTS_SUMMARY.md`** (8.4 KB)
  - –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–æ—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
  - –í—Ö–æ–¥—ã/–≤—ã—Ö–æ–¥—ã –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
  - –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä workflow
  - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ latent —Ç–µ–Ω–∑–æ—Ä–æ–≤

- **`WAN_WORKFLOW_DIAGRAM.md`** (17.1 KB)
  - ASCII –¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —à–∞–≥–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  - –°—Ö–µ–º—ã —Ñ–æ—Ä–º —Ç–µ–Ω–∑–æ—Ä–æ–≤
  - –°—Ö–µ–º–∞ conditioning

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- **`test_wan_bricks.py`** (6.7 KB)
  - –¢–µ—Å—Ç –∏–º–ø–æ—Ä—Ç–æ–≤
  - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∏–≥–Ω–∞—Ç—É—Ä —Ñ—É–Ω–∫—Ü–∏–π
  - –¢–∞–±–ª–∏—Ü–∞ –≤—Ö–æ–¥–æ–≤/–≤—ã—Ö–æ–¥–æ–≤
  - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è
- **`README.md`** (–æ–±–Ω–æ–≤–ª–µ–Ω)
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è "Wan Video Generation Bricks"
  - –°—Å—ã–ª–∫–∏ –Ω–∞ –Ω–æ–≤—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
  - –ë—ã—Å—Ç—Ä—ã–π –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Load CLIP Vision
```python
load_clip_vision(clip_name: str) ‚Üí clip_vision
```
–ó–∞–≥—Ä—É–∑–∫–∞ CLIP Vision –º–æ–¥–µ–ª–∏ –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

**–ò—Å—Ç–æ—á–Ω–∏–∫:** `CLIPVisionLoader` –∏–∑ `nodes.py:985-1000`

---

### 2. CLIP Vision Encode
```python
clip_vision_encode(clip_vision, image, crop='center') ‚Üí clip_vision_output
```
–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ CLIP Vision —ç–º–±–µ–¥–¥–∏–Ω–≥–∏.

**–ò—Å—Ç–æ—á–Ω–∏–∫:** `CLIPVisionEncode` –∏–∑ `nodes.py:1002-1019`

---

### 3. Load VAE
```python
load_vae(vae_name: str) ‚Üí vae
```
–ó–∞–≥—Ä—É–∑–∫–∞ VAE –º–æ–¥–µ–ª–∏. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ `.safetensors` —Ñ–∞–π–ª—ã
- TAESD (Tiny AutoEncoder) –º–æ–¥–µ–ª–∏
- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π `"pixel_space"` —Ä–µ–∂–∏–º

**–ò—Å—Ç–æ—á–Ω–∏–∫:** `VAELoader` –∏–∑ `nodes.py:694-786`

---

### 4. Load CLIP (Text Encoder)
```python
load_clip(clip_name: str, clip_type: str = 'wan', device: str = 'default') ‚Üí clip
```
–ó–∞–≥—Ä—É–∑–∫–∞ CLIP text encoder. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç GGUF —Ñ–æ—Ä–º–∞—Ç!**

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã:**
- `"wan"` - –¥–ª—è Wan –º–æ–¥–µ–ª–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- `"sd3"`, `"flux"`, `"stable_diffusion"` –∏ –¥—Ä.

**–ò—Å—Ç–æ—á–Ω–∏–∫:** `CLIPLoader` –∏–∑ `nodes.py:928-953`

---

### 5. Wan Image to Video
```python
wan_image_to_video(
    positive, negative, vae,
    width=832, height=480, length=81,
    batch_size=1,
    clip_vision_output=None,
    start_image=None
) ‚Üí (positive, negative, latent)
```
–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ conditioning –∏ latent –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –°–æ–∑–¥–∞–µ—Ç –ø—É—Å—Ç–æ–π latent —Å —Ñ–æ—Ä–º–æ–π `[batch, 16, temporal, H/8, W/8]`
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (encoding + masking)
- –î–æ–±–∞–≤–ª—è–µ—Ç CLIP Vision conditioning
- –ì–æ—Ç–æ–≤–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è —Å—ç–º–ø–ª–∏–Ω–≥–∞

**–ò—Å—Ç–æ—á–Ω–∏–∫:** `WanImageToVideo` –∏–∑ `comfy_extras/nodes_wan.py:15-60`

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### Latent Structure
Wan –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É latent:
- **16 –∫–∞–Ω–∞–ª–æ–≤** (–≤–º–µ—Å—Ç–æ 4 —É SD)
- **–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ 4x**: `T = ((length-1)//4)+1`
- **–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ 8x**: `H/8 √ó W/8`

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –î–ª–∏–Ω–∞ –≤–∏–¥–µ–æ: `length % 4 == 1` (17, 33, 49, 81, 97, ...)
- –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã: –∫—Ä–∞—Ç–Ω—ã 8

### Conditioning
Wan –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∏–ø–æ–≤ conditioning:
1. **Text** - CLIP text embeddings
2. **CLIP Vision** - image embeddings
3. **Concat Latent** - encoded start/control images
4. **Concat Mask** - –º–∞—Å–∫–∞ –æ–±–ª–∞—Å—Ç–µ–π –¥–ª—è denoising

## –¢–∏–ø–∏—á–Ω—ã–π Workflow

```python
# 1. –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π
clip = load_clip("umt5_xxl.safetensors", clip_type="wan")
clip_vision = load_clip_vision("clip_vision_g.safetensors")
vae = load_vae("wan_2.1_vae.safetensors")

# 2. –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
positive = clip_encode(clip, "a cat walking")
negative = clip_encode(clip, "blurry")

# 3. –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
clip_vision_output = clip_vision_encode(clip_vision, image)

# 4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–∏–¥–µ–æ
positive, negative, latent = wan_image_to_video(
    positive, negative, vae,
    width=832, height=480, length=81,
    clip_vision_output=clip_vision_output,
    start_image=first_frame
)

# 5. –°—ç–º–ø–ª–∏–Ω–≥
samples, seed = common_ksampler(
    model, latent, positive, negative,
    steps=20, cfg=7.0
)

# 6. –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
video = vae_decode(vae, samples)
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ComfyUI

### –ò–º–ø–æ—Ä—Ç—ã –∏–∑ ComfyUI
–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä—è–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏–∑ –ø–æ–ª–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ComfyUI:
```python
import comfy.clip_vision
import comfy.model_management
import comfy.sd
import comfy.utils
import folder_paths
import node_helpers
```

### –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ sys.path
```python
comfyui_path = Path(__file__).parent.parent / "ComfyUI"
if str(comfyui_path) not in sys.path:
    sys.path.insert(0, str(comfyui_path))
```

### –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ª–∏–Ω—Ç–µ—Ä–∞
–ò–º–ø–æ—Ä—Ç—ã –ø–æ–º–µ—á–µ–Ω—ã `# type: ignore` —Ç–∞–∫ –∫–∞–∫ –ª–∏–Ω—Ç–µ—Ä –Ω–µ –≤–∏–¥–∏—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—É—Ç–∏.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –º–æ–¥–µ–ª—è–º

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
1. **CLIP Text Encoder**: `umt5_xxl` (–∏–ª–∏ GGUF –≤–µ—Ä—Å–∏—è)
2. **VAE**: `wan_2.1_vae.safetensors` –∏–ª–∏ `wan_2.2_vae.safetensors`
3. **Diffusion Model**: Wan 2.1 –∏–ª–∏ 2.2 checkpoint

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
1. **CLIP Vision**: `clip_vision_g.safetensors` (–¥–ª—è image conditioning)

### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ
```
models_storage/
‚îú‚îÄ‚îÄ text_encoders/
‚îÇ   ‚îî‚îÄ‚îÄ umt5_xxl.safetensors
‚îú‚îÄ‚îÄ clip_vision/
‚îÇ   ‚îî‚îÄ‚îÄ clip_vision_g.safetensors
‚îú‚îÄ‚îÄ vae/
‚îÇ   ‚îî‚îÄ‚îÄ wan_2.1_vae.safetensors
‚îî‚îÄ‚îÄ checkpoints/
    ‚îî‚îÄ‚îÄ wan_2.1.safetensors
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
cd /qs/kino/backend
python bricks/test_wan_bricks.py
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç
```
‚úì All imports successful!

Function Signatures:
...

Input/Output Summary:
...

Complete Workflow Example:
...
```

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- **Python**: 3.12+
- **PyTorch**: –° –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π CUDA/XPU
- **ComfyUI**: –ü–æ–ª–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (–Ω–µ stripped –≤–µ—Ä—Å–∏—è)
- **OS**: Linux, Windows, macOS

## –°—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–∏–∫–∏

### ComfyUI Nodes
1. **CLIPVisionLoader**: `/qs/kino/backend/ComfyUI/nodes.py:985-1000`
2. **CLIPVisionEncode**: `/qs/kino/backend/ComfyUI/nodes.py:1002-1019`
3. **VAELoader**: `/qs/kino/backend/ComfyUI/nodes.py:694-786`
4. **CLIPLoader**: `/qs/kino/backend/ComfyUI/nodes.py:928-953`
5. **WanImageToVideo**: `/qs/kino/backend/ComfyUI/comfy_extras/nodes_wan.py:15-60`

### Kino Bricks
1. **wan_bricks.py**: `/qs/kino/backend/bricks/wan_bricks.py`
2. **comfy_bricks.py**: `/qs/kino/backend/bricks/comfy_bricks.py`

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
1. –î–æ–±–∞–≤–∏—Ç—å `DualCLIPLoader` –¥–ª—è –º–æ–¥–µ–ª–µ–π —Ç—Ä–µ–±—É—é—â–∏—Ö 2 CLIP
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `Wan22FunControlToVideo` –¥–ª—è control video
3. –î–æ–±–∞–≤–∏—Ç—å `WanTrackToVideo` –¥–ª—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è
4. –°–æ–∑–¥–∞—Ç—å `WanSoundImageToVideo` –¥–ª—è audio-driven –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø–ª–∞–≥–∏–Ω—ã
–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å Wan –ø–ª–∞–≥–∏–Ω –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å SDXL:
```
plugins/
‚îî‚îÄ‚îÄ wan/
    ‚îú‚îÄ‚îÄ loader.py       # Wan plugin
    ‚îú‚îÄ‚îÄ README.md       # Documentation
    ‚îî‚îÄ‚îÄ __init__.py
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤—Å–µ 5 –±–∞–∑–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è Wan video generation
‚úÖ –°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (4 —Ñ–∞–π–ª–∞)
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –æ—Å–Ω–æ–≤–Ω–æ–π README
‚úÖ –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞

**–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ

